<?xml version="1.0" encoding="UTF-8"?>

<beans:beans xmlns="http://www.springframework.org/schema/security" xmlns:beans="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.2.xsd">

	<!-- ACTIVA EL MODO DEBUG -->
	<!-- <debug /> -->

	<beans:bean id="messageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
		<beans:property name="basename" value="classpath:org/springframework/security/messages_es_ES.properties" />
	</beans:bean>

	<global-method-security pre-post-annotations="enabled">
		<!-- AspectJ pointcut expression that locates our "post" method and applies security that way <protect-pointcut expression="execution(* bigbank.*Service.post*(..))" access="ROLE_TELLER"/> -->
	</global-method-security>


	<http pattern="/errorgeneral.do*" security="none" />
	<http pattern="/css/**" security="none" />
	<http pattern="/js/**" security="none" />
	<http pattern="/images/**" security="none" />
	<http pattern="/fonts/**" security="none" />
	<http pattern="/flash/**" security="none" />
	<http pattern="/scripts/**" security="none" />
	<http pattern="/monitorServicios.servlet*" security="none" />
	<http pattern="/miniapplet/**" security="none" />
	<http pattern="/login*" security="none" />
	<http pattern="/index.jsp" security="none" />
	<http pattern="/common/errorGeneral.jsp" security="none" />
	<http pattern="/404.jsp" security="none" />
	<http pattern="/403.jsp" security="none" />


	<http use-expressions="true" entry-point-ref="autenticacionEntryPoint" access-decision-manager-ref="accessDecisionManagerMOAD">


		<!-- <intercept-url pattern="/index.jsp" access="hasAnyRole('ROLE_ANONYMOUS','ROLE_USER')" /> -->
		<!-- <intercept-url pattern="/login*" access="hasAnyRole('ROLE_ANONYMOUS,ROLE_USER')" /> -->

		<!-- <intercept-url pattern="/login*" access="permitAll" /> -->
		<!-- <intercept-url pattern="/validar.do*" access="permitAll" /> -->
		<!-- <intercept-url pattern="/timeout.do*" access="permitAll" /> -->
		<!-- <intercept-url pattern="/errorGeneral.do*" access="permitAll" /> -->

		<!-- <intercept-url pattern="/login.do*" access="permitAll" /> -->

		<!-- <intercept-url pattern="/login.do" access="isAnonymous()" /> -->
		<!-- <intercept-url pattern="/login.do?**" access="isAnonymous()" /> -->
		<!-- <intercept-url pattern="/errorgeneral.do" access="isAnonymous()" /> -->

		<intercept-url pattern="/paginaprincipal.do*" access="hasAnyRole('MOAD_PF_ADMIN','MOAD_PF_ADMIN_USU','MOAD_PF_ADMIN_APP','MOAD_PF_CONSULTA_APP')" />
		<intercept-url pattern="/monitorservicios.servlet" access="hasAnyRole('MOAD_PF_ADMIN','MOAD_PF_ADMIN_USU','MOAD_PF_ADMIN_APP','MOAD_PF_CONSULTA_APP')" />
		<intercept-url pattern="/**" access="hasAnyRole('MOAD_PF_ADMIN','MOAD_PF_ADMIN_USU','MOAD_PF_ADMIN_APP','MOAD_PF_CONSULTA_APP')" />


		<custom-filter position="FORM_LOGIN_FILTER" ref="filtroLogin" />


		<logout logout-success-url="/login.do" logout-url="/logout.do" invalidate-session="true" delete-cookies="JSESSIONID" />

		<!-- SI SE DESEA QUE RECUERDE ENTRE SESIONES -->
		<!-- <remember-me /> -->
		<!-- Uncomment to enable X509 client authentication support <x509 /> -->
		<!-- Uncomment to limit the number of sessions a user can have -->
		<session-management invalid-session-url="/timeout.do" session-fixation-protection="newSession">
			<!-- <concurrency-control max-sessions="1" error-if-maximum-exceeded="false" expired-url="/duplicateSession.do" /> -->
		</session-management>

		<access-denied-handler error-page="/paginaPrincipal.do?accessDenied=1" />

	</http>
	<!-- validarConfiguracionTrewa -->
	<!-- ========== Filtros para el acceso ========== -->
	<beans:bean id="autenticacionEntryPoint" class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint">
		<beans:property name="loginFormUrl" value="/login.do" />
	</beans:bean>

	<beans:bean id="filtroLogin" class="es.ja.cice.pct.moad.webapp.security.spring.AutenticacionUsuarioFiltro">
		<beans:property name="modificacionPasswordValidador" ref="modificacionPasswordValidador" />
		<beans:property name="authenticationManager" ref="autenticacionManager" />
		<beans:property name="authenticationFailureHandler" ref="loginMappingFailureHandler" />
		<beans:property name="authenticationSuccessHandler" ref="loginSuccessHandler" />
		<beans:property name="afirmaPCTManager" ref="afirmaPCTManager" />
		<beans:property name="authModel" value="${moad.auth.model}" />
	</beans:bean>

	<beans:bean id="modificacionPasswordValidador" class="es.ja.cice.pct.moad.webapp.security.spring.ChangePasswordValidatorWrapper">
		<beans:property name="managerUsuarios" ref="IUsuariosManager" />
		<beans:property name="cryptoHelper" ref="cryptoHelper" />
	</beans:bean>

	<beans:bean id="loginSuccessHandler" class="org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler">
		<beans:property name="defaultTargetUrl" value="/paginaPrincipal.do" />
		<beans:property name="alwaysUseDefaultTargetUrl" value="true" />
	</beans:bean>

	<!-- <beans:bean id="loginMappingFailureHandler" class="org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler"> -->
	<!-- <beans:property name="defaultFailureUrl" value="/login.do?errorLogin=1" /> -->
	<!-- <beans:property name="exceptionMappings"> -->
	<!-- <beans:map> -->
	<!-- <beans:entry key="org.springframework.security.authentication.CredentialsExpiredException" value="/login.do?errorLogin=2" /> -->
	<!-- <beans:entry key="org.springframework.security.core.AuthenticationException" value="/login.do?errorLogin=7" /> -->
	<!-- <beans:entry key="org.springframework.security.authentication.BadCredentialsException" value="/login.jsp?errorMessage=disabled.user" /> -->
	<!-- </beans:map> -->
	<!-- </beans:property> -->
	<!-- </beans:bean> -->

	<beans:bean id="loginMappingFailureHandler" class="es.ja.cice.pct.moad.webapp.security.spring.AutenticacionUsuarioFailureHandler">
		<beans:property name="defaultFailureUrl" value="/login.do?errorLogin=1" />
		<beans:property name="exceptionMappings">
			<beans:map>
				<beans:entry key="org.springframework.security.authentication.CredentialsExpiredException" value="/login.do?errorLogin=2" />
				<beans:entry key="org.springframework.security.core.AuthenticationException" value="/login.do?errorLogin=7" />
			</beans:map>
		</beans:property>
	</beans:bean>

	<!-- ========== VOTER ========== -->
	<!-- <beans:bean id="accessDecisionManagerMOAD" class="org.springframework.security.access.vote.UnanimousBased"> -->
	<beans:bean id="accessDecisionManagerMOAD" class="org.springframework.security.access.vote.AffirmativeBased">
		<beans:property name="allowIfAllAbstainDecisions" value="false" />
		<beans:property name="decisionVoters">
			<beans:list>
				<beans:bean class="es.ja.cice.pct.moad.webapp.security.spring.ProcRoleVoter">
					<beans:property name="rolePrefix" value="MOAD_PF" />
					<beans:property name="privilegiosService" ref="privilegiosService" />
				</beans:bean>
				<beans:bean class="org.springframework.security.access.vote.AuthenticatedVoter" />
			</beans:list>
		</beans:property>
	</beans:bean>

	<beans:bean id="roleVoter" class="es.ja.cice.pct.moad.webapp.security.spring.ProcRoleVoter">
		<beans:property name="rolePrefix" value="MOAD_PF" />
		<beans:property name="privilegiosService" ref="privilegiosService" />
	</beans:bean>



	<!-- ====== Autenticación ===== -->
	<authentication-manager alias="autenticacionManager">
		<authentication-provider ref="autenticacionUsuarioProvider" />
	</authentication-manager>

	<beans:bean id="autenticacionUsuarioProvider" class="es.ja.cice.pct.moad.webapp.security.spring.AutenticacionUsuarioProvider">
		<beans:property name="authenticationHandler" ref="IUsuariosManager" />
		<beans:property name="cryptoHelper" ref="cryptoHelper" />
		<beans:property name="perfilesUsuManager" ref="IPerfilesUsuManager" />
		<beans:property name="authModel" value="${moad.auth.model}" />
	</beans:bean>

	<!-- ========= Definición de los beans auxiliares para la validación ======== -->
	<beans:bean id="codificadorPassword" class="es.ja.cice.pct.moad.webapp.security.spring.CodificadorPassword" />
	<beans:bean id="cryptoHelper" class="es.ja.cice.pct.moad.security.SHA1CryptoHelper" />


	<!-- ====== Definición de bean para la carga de privilegios en el contexto de aplicación desde la BBDD ===== -->
	<beans:bean name="privilegiosService" class="es.ja.cice.pct.moad.webapp.security.spring.PrivilegiosService" lazy-init="false" init-method="init">

		<beans:property name="perfilesUsuManager" ref="IPerfilesUsuManager" />
		<beans:property name="mapaPrivilegiosURL">
			<beans:map>
				<beans:entry key="MOAD_PV_GESTAB_CONSULTA">
					<beans:set>
						<beans:value>paginaPrincipal</beans:value>
						<beans:value>errorGeneral</beans:value>

						<beans:value>listadoListados</beans:value>
						<beans:value>listadoRoles</beans:value>
						<beans:value>listadoConfiguraciones</beans:value>
						<beans:value>listadoConfiguracionHerramientas</beans:value>
						<beans:value>exportarConfiguracion</beans:value>
						<beans:value>listadoHerramientas</beans:value>
						<beans:value>listadoAplicaciones</beans:value>
						<beans:value>listadoOficinas</beans:value>
						<beans:value>listadoTiposCertificados</beans:value>
						<beans:value>listadoMenus</beans:value>
						<beans:value>listadoConfiguracionTrewa</beans:value>

						<beans:value>editarListado</beans:value>
						<beans:value>editarCampo</beans:value>
						<beans:value>editarRol</beans:value>
						<beans:value>editarConfiguracion</beans:value>
						<beans:value>editarInstHerramienta</beans:value>
						<beans:value>editarHerramienta</beans:value>
						<beans:value>editarParametro</beans:value>
						<beans:value>editarAplicacion</beans:value>
						<beans:value>editarOficina</beans:value>
						<beans:value>editarTiposCertificados</beans:value>
						<beans:value>editarMenus</beans:value>
						<beans:value>editarSubMenus</beans:value>
						<beans:value>editarConfiguracionTrewa</beans:value>
					</beans:set>
				</beans:entry>
				<beans:entry key="MOAD_PV_GESTAB_EDICION">
					<beans:set>
						<beans:value>paginaPrincipal</beans:value>
						<beans:value>errorGeneral</beans:value>

						<beans:value>listadoListados</beans:value>
						<beans:value>editarListado</beans:value>
						<beans:value>crearListado</beans:value>
						<beans:value>borrarListado</beans:value>
						<beans:value>editarCampo</beans:value>
						<beans:value>crearCampo</beans:value>
						<beans:value>borrarCampo</beans:value>

						<beans:value>listadoRoles</beans:value>
						<beans:value>crearRol</beans:value>
						<beans:value>editarRol</beans:value>
						<beans:value>borrarRol</beans:value>
						<beans:value>asignarFuncionalidad</beans:value>
						<beans:value>revocarFuncionalidad</beans:value>

						<beans:value>listadoConfiguraciones</beans:value>
						<beans:value>listadoConfiguracionHerramientas</beans:value>
						<beans:value>editarConfiguracion</beans:value>
						<beans:value>crearConfiguracion</beans:value>
						<beans:value>borrarConfiguracion</beans:value>
						<beans:value>importarConfiguracion</beans:value>
						<beans:value>exportarConfiguracion</beans:value>
						<beans:value>editarInstHerramienta</beans:value>

						<beans:value>listadoHerramientas</beans:value>
						<beans:value>editarHerramienta</beans:value>
						<beans:value>crearHerramienta</beans:value>
						<beans:value>borrarHerramienta</beans:value>
						<beans:value>editarParametro</beans:value>
						<beans:value>crearParametro</beans:value>
						<beans:value>borrarParametro</beans:value>

						<beans:value>listadoAplicaciones</beans:value>
						<beans:value>crearAplicacion</beans:value>
						<beans:value>editarAplicacion</beans:value>
						<beans:value>borrarAplicacion</beans:value>

						<beans:value>listadoOficinas</beans:value>
						<beans:value>crearOficina</beans:value>
						<beans:value>editarOficina</beans:value>
						<beans:value>borrarOficina</beans:value>
						<beans:value>cambiarContrasenaOficina</beans:value>

						<beans:value>listadoTiposCertificados</beans:value>
						<beans:value>crearTiposCertificados</beans:value>
						<beans:value>editarTiposCertificados</beans:value>
						<beans:value>borrarTiposCertificados</beans:value>

						<beans:value>listadoMenus</beans:value>
						<beans:value>crearMenus</beans:value>
						<beans:value>editarMenus</beans:value>
						<beans:value>borrarMenus</beans:value>
						<beans:value>listadoSubMenus</beans:value>
						<beans:value>crearSubMenus</beans:value>
						<beans:value>editarSubMenus</beans:value>
						<beans:value>borrarSubMenus</beans:value>

						<beans:value>listadoConfiguracionTrewa</beans:value>
						<beans:value>crearConfiguracionTrewa</beans:value>
						<beans:value>editarConfiguracionTrewa</beans:value>
						<beans:value>borrarConfiguracionTrewa</beans:value>
						<beans:value>validarConfiguracionTrewa</beans:value>
						<beans:value>cambiarPassword</beans:value>
					</beans:set>
				</beans:entry>
				<beans:entry key="MOAD_PV_PROC_CONSULTA">
					<beans:set>
						<beans:value>paginaPrincipal</beans:value>
						<beans:value>errorGeneral</beans:value>

						<beans:value>listadoProcedimientoTramites</beans:value>
						<beans:value>listadoProcedimientos</beans:value>
						<beans:value>listadoProcedimientoConfiguraciones</beans:value>
						<beans:value>listadoConfiguracionHerramientas</beans:value>
						<beans:value>listadoProcedimientoListados</beans:value>
						<beans:value>listadoProcedimientoTiposCertificado</beans:value>
						<beans:value>listadoTipoCertificadoPerfiles</beans:value>
						<beans:value>listadoProcedimientoOrdenes</beans:value>
						<beans:value>listadoOrdenConvocatorias</beans:value>
						<beans:value>listadoConvocatoriaPerfiles</beans:value>
						<beans:value>listadoVersionPresentaConvocatorias</beans:value>
						<beans:value>listadoProcedimientoVersionesPresenta</beans:value>
						<beans:value>listadoProcedimientoDocumentos</beans:value>
						<beans:value>listadoVersionPresentaPlantillas</beans:value>
						<beans:value>listadoVersionPresentaAnexos</beans:value>
						<beans:value>exportarProcedimiento</beans:value>
						<beans:value>descargarAdjuntoProcedimiento</beans:value>
						<beans:value>descargarAdjuntoConvocatoria</beans:value>
						<beans:value>descargarVersionPresenta</beans:value>
						<beans:value>descargarPlantilla</beans:value>

						<beans:value>chequearIntegridad</beans:value>

						<beans:value>editarInstHerramienta</beans:value>

						<beans:value>editarProcedimiento</beans:value>
						<beans:value>editarOrden</beans:value>
						<beans:value>editarConvocatoria</beans:value>
						<beans:value>editarPerfil</beans:value>
						<beans:value>editarVersionPresenta</beans:value>
						<beans:value>editarPlantilla</beans:value>
						<beans:value>editarAnexo</beans:value>
						<beans:value>editarDocumento</beans:value>
						<beans:value>editarTramite</beans:value>
					</beans:set>
				</beans:entry>

				<beans:entry key="MOAD_PV_PROC_EDICION">
					<beans:set>
						<beans:value>paginaPrincipal</beans:value>
						<beans:value>errorGeneral</beans:value>

						<beans:value>listadoProcedimientoTramites</beans:value>
						<beans:value>listadoProcedimientos</beans:value>
						<beans:value>listadoProcedimientoConfiguraciones</beans:value>
						<beans:value>listadoConfiguracionHerramientas</beans:value>
						<beans:value>listadoProcedimientoListados</beans:value>
						<beans:value>listadoProcedimientoTiposCertificado</beans:value>
						<beans:value>listadoTipoCertificadoPerfiles</beans:value>
						<beans:value>listadoProcedimientoOrdenes</beans:value>
						<beans:value>listadoOrdenConvocatorias</beans:value>
						<beans:value>listadoConvocatoriaPerfiles</beans:value>
						<beans:value>listadoVersionPresentaConvocatorias</beans:value>
						<beans:value>listadoProcedimientoVersionesPresenta</beans:value>
						<beans:value>listadoProcedimientoDocumentos</beans:value>
						<beans:value>listadoVersionPresentaPlantillas</beans:value>
						<beans:value>listadoVersionPresentaAnexos</beans:value>

						<beans:value>chequearIntegridad</beans:value>

						<beans:value>crearProcedimiento</beans:value>
						<beans:value>editarProcedimiento</beans:value>
						<beans:value>borrarProcedimiento</beans:value>
						<beans:value>exportarProcedimiento</beans:value>
						<beans:value>importarProcedimiento</beans:value>
						<beans:value>cambiarClaveCifrado</beans:value>

						<beans:value>asignarListado</beans:value>
						<beans:value>revocarListado</beans:value>

						<beans:value>asignarTipoCertificado</beans:value>
						<beans:value>revocarTipoCertificado</beans:value>
						<beans:value>asignarPerfilTipoCertificado</beans:value>
						<beans:value>revocarPerfilTipoCertificado</beans:value>

						<beans:value>borrarOrden</beans:value>
						<beans:value>crearOrden</beans:value>
						<beans:value>editarOrden</beans:value>


						<beans:value>crearConvocatoria</beans:value>
						<beans:value>editarConvocatoria</beans:value>
						<beans:value>borrarConvocatoria</beans:value>

						<beans:value>descargarAdjuntoConvocatoria</beans:value>
						<beans:value>descargarAdjuntoProcedimiento</beans:value>

						<beans:value>editarPerfil</beans:value>
						<beans:value>crearPerfil</beans:value>
						<beans:value>borrarPerfil</beans:value>


						<beans:value>asignarTipoIdentificacionPerfil</beans:value>
						<beans:value>revocarTipoIdentificacionPerfil</beans:value>

						<beans:value>borrarTramite</beans:value>
						<beans:value>editarTramite</beans:value>
						<beans:value>crearTramite</beans:value>

						<beans:value>asignarConvocatoriaVersionPresenta</beans:value>
						<beans:value>revocarConvocatoriaVersionPresenta</beans:value>

						<beans:value>borrarVersionPresenta</beans:value>
						<beans:value>editarVersionPresenta</beans:value>
						<beans:value>crearVersionPresenta</beans:value>
						<beans:value>descargarVersionPresenta</beans:value>

						<beans:value>crearDocumento</beans:value>
						<beans:value>editarDocumento</beans:value>
						<beans:value>borrarDocumento</beans:value>

						<beans:value>crearPlantilla</beans:value>
						<beans:value>editarPlantilla</beans:value>
						<beans:value>borrarPlantilla</beans:value>
						<beans:value>descargarPlantilla</beans:value>

						<beans:value>crearAnexo</beans:value>
						<beans:value>editarAnexo</beans:value>
						<beans:value>borrarAnexo</beans:value>

						<beans:value>crearInstHerramienta</beans:value>
						<beans:value>editarInstHerramienta</beans:value>
						<beans:value>borrarInstHerramienta</beans:value>
						<beans:value>chequearConfiguracion</beans:value>
						<beans:value>cambiarClaveInstParametro</beans:value>
					</beans:set>
				</beans:entry>

				<beans:entry key="MOAD_PV_USUA_CONSULTA">
					<beans:set>
						<beans:value>paginaPrincipal</beans:value>
						<beans:value>errorGeneral</beans:value>

						<beans:value>listadoUsuarios</beans:value>
						<beans:value>listadoUsuarioRoles</beans:value>
						<beans:value>listadoUsuarioPerfiles</beans:value>
						<beans:value>mostrarUsuario</beans:value>
						<beans:value>listadoUsuarioEmpleos</beans:value>
						<beans:value>listadoUsuarioConfTrewa</beans:value>
					</beans:set>
				</beans:entry>

				<beans:entry key="MOAD_PV_USUA_EDICION">
					<beans:set>
						<beans:value>paginaPrincipal</beans:value>
						<beans:value>errorGeneral</beans:value>

						<beans:value>listadoUsuarios</beans:value>
						<beans:value>listadoUsuarioRoles</beans:value>
						<beans:value>listadoUsuarioPerfiles</beans:value>
						<beans:value>mostrarUsuario</beans:value>
						<beans:value>listadoUsuarioEmpleos</beans:value>
						<beans:value>listadoUsuarioConfTrewa</beans:value>

						<beans:value>editarUsuario</beans:value>
						<beans:value>comprobarUsuario</beans:value>
						<beans:value>crearUsuario</beans:value>
						<beans:value>borrarUsuario</beans:value>
						<beans:value>crearEmpleo</beans:value>
						<beans:value>editarEmpleo</beans:value>
						<beans:value>sincronizarEmpleo</beans:value>
						<beans:value>revocarConfiguracionTrewa</beans:value>
						<beans:value>asignarConfiguracionTrewa</beans:value>
						<beans:value>sincronizarConfTrewa</beans:value>
						<beans:value>sincronizarPerfil</beans:value>
						<beans:value>revocarPerfil</beans:value>
						<beans:value>revocarRol</beans:value>
						<beans:value>borrarEmpleo</beans:value>
						<beans:value>asignarRol</beans:value>
						<beans:value>asignarPerfil</beans:value>
						<beans:value>cambiarContrasena</beans:value>

					</beans:set>
				</beans:entry>
				<beans:entry key="MOAD_PV_PERFUSU_CONSULTA">
					<beans:set>
						<beans:value>paginaPrincipal</beans:value>
						<beans:value>errorGeneral</beans:value>

						<beans:value>listadoUsuarioPerfilesMoad</beans:value>
					</beans:set>
				</beans:entry>
				<beans:entry key="MOAD_PV_PERFUSU_EDICION">
					<beans:set>
						<beans:value>paginaPrincipal</beans:value>
						<beans:value>errorGeneral</beans:value>

						<beans:value>listadoUsuarioPerfilesMoad</beans:value>
						<beans:value>asignarPerfilMoad</beans:value>
						<beans:value>revocarPerfilMoad</beans:value>
					</beans:set>
				</beans:entry>
			</beans:map>
		</beans:property>
	</beans:bean>

	<!-- ====== Definición de los beans para el registro de usuarios en BBDD ===== -->
	<beans:bean id="securityContextWrapper" class="es.ja.cice.pct.moad.webapp.security.spring.RemoteUserDetailsWrapper" />

</beans:beans>